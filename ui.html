<style>
  @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap");

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family:
      "Inter",
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      sans-serif;
    background: linear-gradient(180deg, #e8ebe9 0%, #fff 100%);
    min-height: 100vh;
    color: #1a1a1a;
    font-size: 13px;
    line-height: 1.5;
  }

  /* Accent Colors */
  :root {
    --accent: #4a5d52;
    --accent-hover: #3d4f45;
    --accent-light: #e8ebe9;
    --accent-lighter: #f4f5f4;
    --text-primary: #1a1a1a;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    --bg-card: #ffffff;
    --bg-subtle: #f9fafb;
    --border: #e5e7eb;
    --border-focus: #ffd60a;
    --success: #10b981;
    --error: #ef4444;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md:
      0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg:
      0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-full: 9999px;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 700;
    font-size: 14px;
    color: var(--text-primary);
  }

  .logo-icon {
    width: 24px;
    height: 24px;
    background: var(--accent);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }

  /* Navigation Tabs */
  .nav-tabs {
    display: flex;
    gap: 4px;
    padding: 8px 12px;
    background: var(--bg-card);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .nav-tabs::-webkit-scrollbar {
    display: none;
  }

  .nav-tab {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 7px 12px;
    background: var(--bg-subtle);
    border: none;
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    font-family: inherit;
  }

  .nav-tab:hover {
    background: var(--accent-light);
    color: var(--text-primary);
  }

  .nav-tab.active {
    background: var(--accent);
    color: #ffffff;
    box-shadow: var(--shadow-sm);
  }

  .nav-tab-icon {
    font-size: 12px;
  }

  /* Main Content */
  .main-content {
    padding: 12px 12px;
  }

  /* Tab Content */
  .tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .tab-content.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Section Title */
  .section-title {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 2px;
    letter-spacing: -0.02em;
  }

  .section-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 12px;
  }

  /* Cards */
  .card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 14px;
    margin-bottom: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .card-icon {
    width: 32px;
    height: 32px;
    background: var(--accent-light);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .card-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .card-desc {
    font-size: 11px;
    color: var(--text-secondary);
  }

  /* Preview Banner */
  .preview-banner {
    background: linear-gradient(135deg, var(--accent) 0%, #1a5c3a 100%);
    border-radius: var(--radius-md);
    padding: 10px 14px;
    margin-bottom: 12px;
    position: relative;
    overflow: hidden;
  }

  .preview-banner::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -20%;
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
  }

  .preview-label {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 3px;
  }

  .preview-text {
    font-size: 13px;
    font-weight: 700;
    color: #ffffff;
    word-break: break-word;
    position: relative;
    z-index: 1;
  }

  /* Form Elements */
  .form-group {
    margin-bottom: 10px;
  }

  .form-label {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .form-label .required {
    color: var(--error);
  }

  .form-input {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg-subtle);
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-family: inherit;
    color: var(--text-primary);
    transition: all 0.2s ease;
  }

  .form-input::placeholder {
    color: var(--text-muted);
  }

  .form-input:hover {
    background: #f3f4f6;
  }

  .form-input:focus {
    outline: none;
    background: var(--bg-card);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-light);
  }

  textarea.form-input {
    resize: vertical;
    min-height: 60px;
  }

  .form-hint {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 3px;
    display: none;
  }

  /* Tags Input Display */
  .tags-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 6px;
  }

  .tag-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: var(--accent);
    color: white;
    border-radius: var(--radius-full);
    font-size: 11px;
    font-weight: 600;
    cursor: default;
  }

  .tag-chip-remove {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 14px;
    height: 14px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    cursor: pointer;
    font-size: 9px;
    line-height: 1;
    transition: background 0.15s ease;
  }

  .tag-chip-remove:hover {
    background: rgba(255, 255, 255, 0.4);
  }

  /* Buttons */
  .btn-group {
    display: flex;
    gap: 8px;
    margin-top: 14px;
  }

  .btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .btn-primary {
    background: var(--accent);
    color: #ffffff;
    box-shadow: var(--shadow-md);
  }

  .btn-primary:hover {
    background: var(--accent-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-lg);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-primary:disabled {
    background: var(--border);
    color: var(--text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-secondary {
    background: var(--bg-subtle);
    color: var(--text-secondary);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: #f3f4f6;
    color: var(--text-primary);
  }

  .btn-success {
    background: var(--success) !important;
    color: #ffffff !important;
  }

  /* Project Type Grid */
  .project-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
  }

  .project-card {
    position: relative;
    padding: 10px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition:
      border-color 0.3s ease,
      background-color 0.3s ease,
      box-shadow 0.3s ease;
    overflow: hidden;
  }

  .project-card:hover {
    border-color: rgba(0, 58, 31, 0.3);
    background: var(--accent-lighter);
    box-shadow: 0 2px 8px rgba(0, 58, 31, 0.08);
  }

  .project-card.selected {
    border-color: var(--accent);
    background: var(--accent-light);
    box-shadow: 0 0 0 2px rgba(0, 58, 31, 0.1);
  }

  .project-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .project-card-icon {
    width: 28px;
    height: 28px;
    background: var(--accent-light);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    color: #ffffff;
  }

  .project-card-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .project-card-desc {
    font-size: 10px;
    color: var(--text-secondary);
    margin-bottom: 6px;
    line-height: 1.3;
    display: none;
  }

  .project-card-pages {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
  }

  .page-tag {
    padding: 2px 6px;
    background: var(--bg-subtle);
    border-radius: var(--radius-sm);
    font-size: 9px;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .project-card.selected .page-tag {
    background: rgba(255, 255, 255, 0.7);
  }

  /* Custom Structure Textarea */
  .custom-structure-box {
    display: none;
    margin-top: 10px;
    padding: 12px;
    background: var(--bg-subtle);
    border-radius: var(--radius-md);
    border: 1px dashed var(--border);
    animation: fadeIn 0.3s ease;
  }

  .custom-structure-box.visible {
    display: block;
  }

  /* Status Banner */
  .status-banner {
    padding: 14px 16px;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .status-banner.info {
    background: var(--accent-light);
    color: var(--text-primary);
  }

  .status-banner.success {
    background: #d1fae5;
    color: #065f46;
  }

  .status-banner.error {
    background: #fee2e2;
    color: #991b1b;
  }

  .status-icon {
    font-size: 16px;
  }

  /* File Input Styling */
  .file-input-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    background: var(--bg-subtle);
    border: 2px dashed var(--border);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .file-input-wrapper:hover {
    border-color: var(--accent);
    background: var(--accent-light);
  }

  .file-input-wrapper input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .file-input-icon {
    font-size: 32px;
    margin-bottom: 8px;
  }

  .file-input-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .file-input-hint {
    font-size: 11px;
    color: var(--text-muted);
  }

  /* Floating Action Button */
  .fab {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: var(--accent);
    border: none;
    border-radius: 50%;
    box-shadow: var(--shadow-lg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 0.2s ease;
  }

  .fab:hover {
    transform: scale(1.1);
    background: var(--accent-hover);
  }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
  }

  /* Chip/Badge */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--accent);
    border-radius: var(--radius-full);
    font-size: 11px;
    font-weight: 700;
    color: #ffffff;
  }

  .badge-icon {
    font-size: 12px;
  }

  /* Wave Animation for Icon */
  @keyframes wave {
    0%,
    100% {
      transform: rotate(0deg);
    }
    25% {
      transform: rotate(20deg);
    }
    75% {
      transform: rotate(-15deg);
    }
  }

  .wave-icon {
    display: inline-block;
    animation: wave 1s ease-in-out infinite;
    transform-origin: 70% 70%;
  }
</style>

<!-- Header -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">
      <svg width="14" height="14" viewBox="0 0 300 300" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M58 5.00461L120.38 144.605C164.237 138.587 64.592 4.10892 151.84 5.00461V290.605L82.38 112.105C29.4018 120.581 166.321 290.605 58 290.605V5.00461Z" fill="white"/>
        <path d="M198.821 82.5431C257.382 82.5438 257.382 294.605 198.821 294.606C174.299 294.606 162.197 279.108 162.197 247.707C162.197 200.956 142.107 82.5431 198.821 82.5431ZM198.809 118.605C142.824 118.605 216.879 387.704 216.879 192.716C216.879 151.786 208.789 118.605 198.809 118.605ZM206.854 33.6056C213.38 29.1053 222.38 31.1054 225.253 33.6056C228.125 36.1081 204.379 74.1046 201.379 75.6095C198.379 77.1144 194.379 77.1045 193.379 75.6095C192.38 74.1099 200.328 38.1056 206.854 33.6056Z" fill="white"/>
      </svg>
    </div>
    <span>NÃ³</span>
  </div>
</div>

<!-- Navigation Tabs -->
<div class="nav-tabs">
  <button class="nav-tab active" data-tab="rename">
    <span class="nav-tab-icon">&#9997;</span>
    Rename
  </button>
  <button class="nav-tab" data-tab="structure">
    <span class="nav-tab-icon">&#128196;</span>
    Structure
  </button>
  <button class="nav-tab" data-tab="config">
    <span class="nav-tab-icon">&#9881;</span>
    Config
  </button>
</div>

<!-- Main Content -->
<div class="main-content">
  <!-- Tab 1: Rename File -->
  <div class="tab-content active" id="rename-tab">
    <h1 class="section-title">Rename File</h1>
    <p class="section-subtitle">
      Organize your Figma files with a consistent naming convention
    </p>

    <div class="preview-banner">
      <div class="preview-label">Preview</div>
      <div class="preview-text" id="preview">
        Enter product name to see preview
      </div>
    </div>

    <div class="card">
      <div class="form-group">
        <label class="form-label">Client Name</label>
        <input
          id="clientName"
          class="form-input"
          type="text"
          placeholder="e.g., Acme Corp"
        />
        <div class="form-hint">Client or company name (optional)</div>
      </div>

      <div class="form-group">
        <label class="form-label"
          >Product Name <span class="required">*</span></label
        >
        <input
          id="productName"
          class="form-input"
          type="text"
          placeholder="e.g., Dashboard Design"
        />
        <div class="form-hint">Main name for the file</div>
      </div>

      <div class="form-group">
        <label class="form-label">Version</label>
        <input
          id="version"
          class="form-input"
          type="text"
          placeholder="e.g., 1.0, 2.1"
        />
        <div class="form-hint">Version number (optional)</div>
      </div>

      <div class="form-group">
        <label class="form-label">Tags</label>
        <input
          id="tags"
          class="form-input"
          type="text"
          placeholder="e.g., mobile, ios, final"
        />
        <div class="form-hint">Comma-separated tags (optional)</div>
        <div class="tags-preview" id="tagsPreview"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea
          id="description"
          class="form-input"
          placeholder="Additional notes or context..."
        ></textarea>
        <div class="form-hint">Stored as metadata (optional)</div>
      </div>
    </div>

    <div id="fileStatus" class="status-banner info" style="display: none;">
      <span class="status-icon">&#8505;</span>
      <span id="fileStatusText">Checking file name...</span>
    </div>

    <div class="btn-group">
      <button id="renameBtn" class="btn btn-primary" disabled>
        <span>&#128203;</span>
        Copy Name
      </button>
      <button id="cancelBtn1" class="btn btn-secondary">Cancel</button>
    </div>
  </div>

  <!-- Tab 2: Create Structure -->
  <div class="tab-content" id="structure-tab">
    <h1 class="section-title">Create Structure</h1>
    <p class="section-subtitle">
      Set up your project with predefined page templates
    </p>

    <div class="project-grid">
      <div class="project-card" data-type="web-app">
        <div class="project-card-header">
          <div class="project-card-icon">&#127760;</div>
          <div class="project-card-title">Web Application</div>
        </div>
        <div class="project-card-desc">
          Complete structure for web app projects
        </div>
        <div class="project-card-pages">
          <span class="page-tag">Cover</span>
          <span class="page-tag">Design System</span>
          <span class="page-tag">Components</span>
          <span class="page-tag">Flows</span>
          <span class="page-tag">Dev Handoff</span>
        </div>
      </div>

      <div class="project-card" data-type="mobile-app">
        <div class="project-card-header">
          <div class="project-card-icon">&#128241;</div>
          <div class="project-card-title">Mobile App</div>
        </div>
        <div class="project-card-desc">iOS/Android app design structure</div>
        <div class="project-card-pages">
          <span class="page-tag">Cover</span>
          <span class="page-tag">Styleguide</span>
          <span class="page-tag">Screens</span>
          <span class="page-tag">Wireframes</span>
          <span class="page-tag">Prototypes</span>
          <span class="page-tag">Assets</span>
        </div>
      </div>

      <div class="project-card" data-type="design-system">
        <div class="project-card-header">
          <div class="project-card-icon">&#127912;</div>
          <div class="project-card-title">Design System</div>
        </div>
        <div class="project-card-desc">Component library and documentation</div>
        <div class="project-card-pages">
          <span class="page-tag">Cover</span>
          <span class="page-tag">Foundations</span>
          <span class="page-tag">Components</span>
          <span class="page-tag">Patterns</span>
          <span class="page-tag">Documentation</span>
        </div>
      </div>

      <div class="project-card" data-type="website">
        <div class="project-card-header">
          <div class="project-card-icon">&#128640;</div>
          <div class="project-card-title">Marketing Website</div>
        </div>
        <div class="project-card-desc">Landing pages and marketing sites</div>
        <div class="project-card-pages">
          <span class="page-tag">Cover</span>
          <span class="page-tag">Homepage</span>
          <span class="page-tag">Inner Pages</span>
          <span class="page-tag">Components</span>
          <span class="page-tag">Responsive</span>
        </div>
      </div>

      <div class="project-card" data-type="branding">
        <div class="project-card-header">
          <div class="project-card-icon">&#10024;</div>
          <div class="project-card-title">Branding Project</div>
        </div>
        <div class="project-card-desc">Brand identity and guidelines</div>
        <div class="project-card-pages">
          <span class="page-tag">Cover</span>
          <span class="page-tag">Logo</span>
          <span class="page-tag">Colors</span>
          <span class="page-tag">Typography</span>
          <span class="page-tag">Applications</span>
        </div>
      </div>

      <div
        class="project-card"
        data-type="imported"
        id="importedCard"
        style="display: none"
      >
        <div class="project-card-header">
          <div class="project-card-icon">&#128230;</div>
          <div class="project-card-title" id="importedDesc">
            Imported Template
          </div>
        </div>
        <div class="project-card-desc">Custom JSON template</div>
        <div class="project-card-pages" id="importedPages"></div>
      </div>

      <div class="project-card" data-type="custom">
        <div class="project-card-header">
          <div class="project-card-icon" style="background: #7cb68e">
            &#10024;
          </div>
          <div class="project-card-title">Custom Structure</div>
        </div>
        <div class="project-card-desc">Create your own page structure</div>
        <div class="project-card-pages">
          <span class="page-tag">Define custom pages</span>
        </div>
      </div>
    </div>

    <div class="custom-structure-box" id="customStructureInput">
      <div class="form-group" style="margin-bottom: 0">
        <label class="form-label">Page Names (one per line)</label>
        <textarea
          id="customPages"
          class="form-input"
          placeholder="Cover&#10;---&#10;Project Context&#10;---&#10;Competitor Analysis"
          style="min-height: 160px"
        ></textarea>
        <div class="form-hint">
          Use "---" to insert divider pages between sections
        </div>
      </div>
    </div>

    <div class="btn-group">
      <button id="createStructureBtn" class="btn btn-primary" disabled>
        <span>&#128196;</span>
        Create Structure
      </button>
      <button id="cancelBtn2" class="btn btn-secondary">Cancel</button>
    </div>
  </div>

  <!-- Tab 3: Configuration -->
  <div class="tab-content" id="config-tab">
    <h1 class="section-title">Configuration</h1>
    <p class="section-subtitle">Import and manage custom templates</p>

    <div class="card">
      <div class="card-header">
        <div class="card-icon">&#128230;</div>
        <div>
          <div class="card-title">Import Template</div>
          <div class="card-desc">Add a custom JSON template</div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Template Name</label>
        <input
          id="importName"
          class="form-input"
          type="text"
          placeholder="e.g., Client Playbook"
        />
        <div class="form-hint">Used as the card label in Create Structure</div>
      </div>

      <div class="form-group">
        <label class="form-label">Template File</label>
        <div class="file-input-wrapper">
          <input id="importFile" type="file" accept="application/json" />
          <div class="file-input-icon">&#128194;</div>
          <div class="file-input-text">Drop JSON file or click to browse</div>
          <div class="file-input-hint">Accepts .json files</div>
        </div>
      </div>
    </div>

    <div class="status-banner info" id="importStatusBanner">
      <span class="status-icon">&#8505;</span>
      <span id="importStatus">Select a JSON file to validate and save.</span>
    </div>

    <div class="btn-group">
      <button id="saveImportBtn" class="btn btn-primary" disabled>
        <span>&#128190;</span>
        Save Template
      </button>
      <button id="cancelBtn3" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<script>
  // Tab switching
  const tabs = document.querySelectorAll(".nav-tab");
  const tabContents = document.querySelectorAll(".tab-content");

  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const targetTab = tab.dataset.tab;

      tabs.forEach((t) => t.classList.remove("active"));
      tabContents.forEach((tc) => tc.classList.remove("active"));

      tab.classList.add("active");
      document.getElementById(targetTab + "-tab").classList.add("active");
    });
  });

  // ============ RENAME TAB ============
  const clientNameInput = document.getElementById("clientName");
  const productNameInput = document.getElementById("productName");
  const versionInput = document.getElementById("version");
  const tagsInput = document.getElementById("tags");
  const descriptionInput = document.getElementById("description");
  const renameButton = document.getElementById("renameBtn");
  const previewText = document.getElementById("preview");
  const tagsPreview = document.getElementById("tagsPreview");

  // Tags management
  let tagsArray = [];

  function renderTags() {
    tagsPreview.innerHTML = "";
    tagsArray.forEach((tag, index) => {
      const chip = document.createElement("span");
      chip.className = "tag-chip";

      const tagText = document.createElement("span");
      tagText.textContent = tag;
      chip.appendChild(tagText);

      const removeBtn = document.createElement("span");
      removeBtn.className = "tag-chip-remove";
      removeBtn.innerHTML = "&#10005;";
      removeBtn.addEventListener("click", () => {
        tagsArray.splice(index, 1);
        renderTags();
        updatePreview();
      });
      chip.appendChild(removeBtn);

      tagsPreview.appendChild(chip);
    });
  }

  function getTagsString() {
    return tagsArray.join(", ");
  }

  function updatePreview() {
    const clientName = clientNameInput.value.trim();
    const productName = productNameInput.value.trim();
    const version = versionInput.value.trim();

    if (!productName) {
      previewText.textContent = "Enter product name to see preview";
      renameButton.disabled = true;
      return;
    }

    // Build filename: [Client] - Product Name - v1.0 [tags]
    let fileName = "";

    if (clientName) {
      fileName += "[" + clientName + "] ";
    }

    fileName += productName;

    if (version) {
      fileName += " - v" + version;
    }

    if (tagsArray.length > 0) {
      fileName += " [" + tagsArray.join(", ") + "]";
    }

    previewText.textContent = fileName;
    renameButton.disabled = false;
    updateFileStatus();
  }

  // Handle comma to create tag
  tagsInput.addEventListener("input", (e) => {
    const value = tagsInput.value;
    if (value.includes(",")) {
      const parts = value.split(",");
      parts.forEach((part, index) => {
        const trimmed = part.trim();
        // Add all parts except the last one (which stays in the input)
        if (
          index < parts.length - 1 &&
          trimmed &&
          !tagsArray.includes(trimmed)
        ) {
          tagsArray.push(trimmed);
        }
      });
      // Keep only the text after the last comma in the input
      tagsInput.value = parts[parts.length - 1].trimStart();
      renderTags();
      updatePreview();
    }
  });

  // Handle Enter key to create tag
  tagsInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const trimmed = tagsInput.value.trim();
      if (trimmed && !tagsArray.includes(trimmed)) {
        tagsArray.push(trimmed);
        tagsInput.value = "";
        renderTags();
        updatePreview();
      }
    }
    // Handle backspace to remove last tag when input is empty
    if (
      e.key === "Backspace" &&
      tagsInput.value === "" &&
      tagsArray.length > 0
    ) {
      tagsArray.pop();
      renderTags();
      updatePreview();
    }
  });

  clientNameInput.addEventListener("input", updatePreview);
  productNameInput.addEventListener("input", updatePreview);
  versionInput.addEventListener("input", updatePreview);

  // File status elements
  const fileStatus = document.getElementById("fileStatus");
  const fileStatusText = document.getElementById("fileStatusText");
  let currentFileName = "";

  function checkFileNameConvention(fileName) {
    // Pattern: [Client] Product - vX.X [tags] or Product - vX.X [tags]
    // Minimum: just a product name
    if (!fileName || fileName === "Untitled") return { valid: false, message: "File has no name" };

    const generatedName = previewText.textContent;
    if (generatedName === "Enter product name to see preview") return { valid: false, message: "" };

    if (fileName === generatedName) {
      return { valid: true, message: "File name matches convention" };
    }

    // Check if it loosely follows the pattern
    const hasClient = fileName.includes("[") && fileName.includes("]");
    const hasVersion = /v\d/.test(fileName);

    if (hasClient || hasVersion) {
      return { valid: false, message: "File name differs from generated name" };
    }

    return { valid: false, message: "File doesn't follow naming convention" };
  }

  function updateFileStatus() {
    if (!currentFileName) {
      fileStatus.style.display = "none";
      return;
    }

    const result = checkFileNameConvention(currentFileName);
    if (!result.message) {
      fileStatus.style.display = "none";
      return;
    }

    fileStatus.style.display = "flex";
    fileStatusText.textContent = result.message;

    if (result.valid) {
      fileStatus.className = "status-banner success";
      fileStatus.querySelector(".status-icon").innerHTML = "&#10004;";
    } else {
      fileStatus.className = "status-banner info";
      fileStatus.querySelector(".status-icon").innerHTML = "&#8505;";
    }
  }

  renameButton.addEventListener("click", async () => {
    const clientName = clientNameInput.value.trim();
    const productName = productNameInput.value.trim();
    const version = versionInput.value.trim();
    // Include any text remaining in the input as a tag
    const remainingTag = tagsInput.value.trim();
    if (remainingTag && !tagsArray.includes(remainingTag)) {
      tagsArray.push(remainingTag);
    }
    const tags = tagsArray.join(", ");
    const description = descriptionInput.value.trim();

    if (!productName) return;

    // Get the generated name from preview
    const generatedName = previewText.textContent;

    // Copy to clipboard directly in UI
    try {
      await navigator.clipboard.writeText(generatedName);

      // Show success feedback
      renameButton.innerHTML = '<span>&#10004;</span> Copied!';
      renameButton.classList.add("btn-success");

      // Reset button after 2 seconds
      setTimeout(() => {
        renameButton.innerHTML = '<span>&#128203;</span> Copy Name';
        renameButton.classList.remove("btn-success");
      }, 2000);
    } catch (err) {
      // Fallback: use execCommand
      const textArea = document.createElement("textarea");
      textArea.value = generatedName;
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand("copy");
      document.body.removeChild(textArea);

      // Show success feedback
      renameButton.innerHTML = '<span>&#10004;</span> Copied!';
      renameButton.classList.add("btn-success");

      setTimeout(() => {
        renameButton.innerHTML = '<span>&#128203;</span> Copy Name';
        renameButton.classList.remove("btn-success");
      }, 2000);
    }

    // Save metadata
    parent.postMessage(
      {
        pluginMessage: {
          type: "save-metadata",
          clientName,
          productName,
          version,
          tags,
          description,
        },
      },
      "*",
    );
  });

  document.getElementById("cancelBtn1").addEventListener("click", () => {
    parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
  });

  // ============ STRUCTURE TAB ============
  const projectCards = document.querySelectorAll(".project-card");
  const createStructureBtn = document.getElementById("createStructureBtn");
  const customStructureInput = document.getElementById("customStructureInput");
  const customPagesTextarea = document.getElementById("customPages");
  const importedCard = document.getElementById("importedCard");
  const importedDesc = document.getElementById("importedDesc");
  const importedPages = document.getElementById("importedPages");
  let importedTemplateMeta = { name: "", pages: 0 };
  let selectedProjectType = null;

  function setImportedCard(template) {
    if (!template || !template.name || !template.pages) return;
    const pages = Array.isArray(template.pages) ? template.pages : [];
    const pageCount = pages.length || template.pages;
    importedTemplateMeta = { name: template.name, pages: pageCount };
    importedCard.style.display = "block";
    importedDesc.textContent = template.name;
    importedPages.innerHTML = "";

    // Filter out dividers and get actual page names
    const actualPages = pages.filter(
      (p) => p && !p.isDivider && p.name && p.name !== "---",
    );
    const displayPages = actualPages.slice(0, 5);

    displayPages.forEach((page) => {
      const tag = document.createElement("span");
      tag.className = "page-tag";
      tag.textContent = page.name || page;
      importedPages.appendChild(tag);
    });

    if (actualPages.length > 5) {
      const tag = document.createElement("span");
      tag.className = "page-tag";
      tag.textContent = `+${actualPages.length - 5} more`;
      importedPages.appendChild(tag);
    }
    if (selectedProjectType === "imported") {
      updateCreateButtonState();
    }
  }

  function updateCreateButtonState() {
    if (!selectedProjectType) {
      createStructureBtn.disabled = true;
      return;
    }

    if (selectedProjectType === "custom") {
      createStructureBtn.disabled = !customPagesTextarea.value.trim();
      return;
    }

    if (selectedProjectType === "imported") {
      createStructureBtn.disabled = importedTemplateMeta.pages <= 0;
      return;
    }

    createStructureBtn.disabled = false;
  }

  projectCards.forEach((card) => {
    card.addEventListener("click", () => {
      projectCards.forEach((c) => c.classList.remove("selected"));
      card.classList.add("selected");
      selectedProjectType = card.dataset.type;

      // Show/hide custom input
      if (selectedProjectType === "custom") {
        customStructureInput.classList.add("visible");
      } else {
        customStructureInput.classList.remove("visible");
      }

      updateCreateButtonState();
    });
  });

  // Enable button when custom pages are typed
  customPagesTextarea.addEventListener("input", () => {
    updateCreateButtonState();
  });

  createStructureBtn.addEventListener("click", () => {
    if (!selectedProjectType) return;

    const message = {
      type: "create-structure",
      projectType: selectedProjectType,
    };

    // If custom, add the page names
    if (selectedProjectType === "custom") {
      const customPages = customPagesTextarea.value
        .split("\n")
        .map((line) => line.trim())
        .filter((line) => line.length > 0);

      if (customPages.length === 0) return;

      message.customPages = customPages;
    }

    parent.postMessage(
      {
        pluginMessage: message,
      },
      "*",
    );
  });

  document.getElementById("cancelBtn2").addEventListener("click", () => {
    parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
  });

  // ============ CONFIGURATION TAB ============
  const importNameInput = document.getElementById("importName");
  const importFileInput = document.getElementById("importFile");
  const importStatus = document.getElementById("importStatus");
  const importStatusBanner = document.getElementById("importStatusBanner");
  const saveImportBtn = document.getElementById("saveImportBtn");
  const cancelBtn3 = document.getElementById("cancelBtn3");
  let importedTemplatePayload = null;

  function normalizeImportedPages(json) {
    const rawPages = Array.isArray(json) ? json : json?.pages;
    if (!Array.isArray(rawPages)) return [];

    return rawPages
      .map((page) => ({
        name: page.name || "",
        description: page.description || "Custom page",
        bestPractices: Array.isArray(page.bestPractices)
          ? page.bestPractices
          : [],
        isDivider: page.isDivider === true,
      }))
      .filter((page) => page.name);
  }

  function refreshImportStatus(text, type = "info") {
    importStatus.textContent = text;
    importStatusBanner.className = "status-banner " + type;

    const iconMap = {
      info: "&#8505;",
      success: "&#10004;",
      error: "&#10006;",
    };
    importStatusBanner.querySelector(".status-icon").innerHTML =
      iconMap[type] || iconMap.info;
  }

  importFileInput.addEventListener("change", (event) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        const normalizedPages = normalizeImportedPages(parsed);

        if (normalizedPages.length === 0) {
          importedTemplatePayload = null;
          saveImportBtn.disabled = true;
          refreshImportStatus(
            "Invalid JSON: provide an array of pages with names.",
            "error",
          );
          return;
        }

        const derivedName =
          importNameInput.value.trim() || parsed.name || "Imported Template";
        importedTemplatePayload = {
          name: derivedName,
          pages: normalizedPages,
        };

        saveImportBtn.disabled = false;
        refreshImportStatus(
          `Ready to save "${derivedName}" (${normalizedPages.length} pages).`,
          "success",
        );
      } catch (error) {
        importedTemplatePayload = null;
        saveImportBtn.disabled = true;
        refreshImportStatus("Invalid JSON: " + error.message, "error");
      }
    };

    reader.onerror = () => {
      importedTemplatePayload = null;
      saveImportBtn.disabled = true;
      refreshImportStatus("Could not read file.", "error");
    };

    reader.readAsText(file);
  });

  importNameInput.addEventListener("input", () => {
    if (importedTemplatePayload) {
      importedTemplatePayload = {
        ...importedTemplatePayload,
        name: importNameInput.value.trim() || importedTemplatePayload.name,
      };
    }
  });

  saveImportBtn.addEventListener("click", () => {
    if (!importedTemplatePayload || !importedTemplatePayload.name) return;

    parent.postMessage(
      {
        pluginMessage: {
          type: "save-imported-template",
          importedTemplate: importedTemplatePayload,
        },
      },
      "*",
    );

    refreshImportStatus("Saving template...", "info");
    saveImportBtn.disabled = true;
  });

  cancelBtn3.addEventListener("click", () => {
    parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
  });

  // ============ MESSAGE HANDLING ============
  window.onmessage = (event) => {
    const msg = event.data.pluginMessage || event.data;

    // Load existing data and populate fields
    if (msg.type === "load-existing-data") {
      const data = msg.data;
      let hasExistingData = false;

      if (data.clientName) {
        clientNameInput.value = data.clientName;
        hasExistingData = true;
      }
      if (data.productName) {
        productNameInput.value = data.productName;
        hasExistingData = true;
      }
      if (data.version) {
        versionInput.value = data.version;
        hasExistingData = true;
      }
      if (data.tags) {
        // Parse existing tags into array
        tagsArray = data.tags
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t);
        renderTags();
        hasExistingData = true;
      }
      if (data.description) {
        descriptionInput.value = data.description;
        hasExistingData = true;
      }

      // Store current file name for validation
      if (data.currentFileName) {
        currentFileName = data.currentFileName;
      }

      // Update preview if data exists
      updatePreview();

      // Check file name convention after preview is updated
      updateFileStatus();

      if (data.importedTemplateName && data.importedTemplatePages > 0) {
        setImportedCard({
          name: data.importedTemplateName,
          pages: data.importedTemplatePages,
        });
      }

      updateCreateButtonState();
    }

    if (msg.type === "imported-template-saved") {
      const tpl = msg.data;
      if (tpl?.name && tpl.pages?.length) {
        setImportedCard({ name: tpl.name, pages: tpl.pages });
        refreshImportStatus(
          `Saved "${tpl.name}" (${tpl.pages.length} pages).`,
          "success",
        );
      }
    }

  };

  // Focus on product name input on load
  productNameInput.focus();
</script>
